#include ESP8266WiFi.h
#include ESP8266WebServer.h
#include Wire.h
#include aREST.h
#include Adafruit_BMP280.h
#include Adafruit_GFX.h
#include Adafruit_SSD1306.h

#define SCREEN_WIDTH 128 
#define SCREEN_HEIGHT 64 

const char ssid = Roman_NET;
const char password = Kirovakan_1;

aREST rest = aREST();

Adafruit_BMP280 bmp;
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);



WiFiServer server(80);

float temperature;
float pressure;

void setup() {
  Serial.begin(115200);

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println(F(SSD1306 allocation failed));
    for(;;);
  }
   if(!bmp.begin(BMP280_ADDRESS_ALT) ) { 
    Serial.println(BMP280 SENSOR ERROR); 
    while(1); 
  }

  rest.variable(temperature,&temperature);
  rest.variable(pressure,&pressure);

  rest.set_id(1);
  rest.set_name(esp8266);

  
  if(!bmp.begin(BMP280_ADDRESS_ALT) ) { 
    Serial.println(BMP280 SENSOR ERROR); 
    while(1);
  }
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(.);
  }
  Serial.println();
  Serial.println(WiFi connected);
    

  
  server.begin();
  
  while(!server.available()){
    Serial.println(Server initialization error);
    delay(500); 
  }
  Serial.println(server.status());
  Serial.println(Server started);                                            
  Serial.println(WiFi.localIP());

  

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 10);
  display.println(WiFi.localIP());

  
  
  display.display(); 
}

void loop() {
  pressure = bmp.readPressure();
  temperature = bmp.readTemperature();

  WiFiClient client = server.available();
  if (!client) {
      return;
  }
  while(!client.available()){
      delay(1);
  }
  rest.handle(client);
  
  
  delay(100);
  display.clearDisplay();
  display.setCursor(0, 10);
  display.println(WiFi.localIP());
  display.print(Temp );
  display.println(bmp.readTemperature());
  display.print(Pressure );
  display.println(bmp.readPressure());
  display.print(Altitude );
  display.println(bmp.readAltitude(1013.25));
  display.display();
}